<?php
error_reporting(0);
ini_set('display_errors', '0');
error_reporting(E_ALL);
ob_start(); // Prevent early output

include 'sqlConnection.php';
$identifier = intval($_GET['identifier']);  // Sanitized input to prevent SQL injection 
include 'timezoneFunction.php'; 

$generatedByUsername = $_SESSION['userId'];
$generatedByFullName = $_SESSION['fullName'];
$generatedTimestamp = date('Y-m-d H:i:s');
$generatedDate = date('d-m-Y');

function formatBytes($bytes, $precision = 2) {
    $units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

    $bytes = max($bytes, 0);
    $pow = floor(($bytes ? log($bytes) : 0) / log(1024));
    $bytes /= pow(1024, $pow);

    return round($bytes, $precision) . ' ' . $units[$pow];
}

$sql = "SELECT CaseReference, LeadInvestigator FROM cases WHERE Identifier = ?";
$stmt = $connection->prepare($sql);
$stmt->bind_param("s", $identifier);
$stmt->execute();
$stmt->bind_result($caseReference, $leadInvestigator);
$stmt->fetch();
mysqli_stmt_close($stmt);

$sql = "SELECT FullName FROM users WHERE Username = ?";
$stmt = $connection->prepare($sql);
$stmt->bind_param("s", $leadInvestigator);
$stmt->execute();
$stmt->bind_result($leadInvestigatorFullName);
$stmt->fetch();
mysqli_stmt_close($stmt);

require_once('vendor/autoload.php');

class CustomPDF extends TCPDF {
    public function Footer() {
        $this->SetY(-15);
        $this->SetLineWidth(0.3); // Adjust the thickness here (e.g., 0.5mm)
        $this->Line(15, $this->getY(), $this->getPageWidth() - 15, $this->getY());

        $this->SetFont('helvetica', 'I', 8);
        $this->SetY($this->getY() - 2);

        $this->Cell(0, 10, 'Page ' . $this->getAliasNumPage() . ' of ' . $this->getAliasNbPages(), 0, false, 'R');
    }
}

$pdf = new CustomPDF();

$pdf->SetCreator(PDF_CREATOR);
$pdf->SetAuthor('DFCMS');
$pdf->SetTitle('Case Report (' . $caseReference . ')');

$pdf->SetHeaderData('', 0, 'Case Reference: ' . $caseReference, 'Report Generated By DFCMS');

$pdf->SetMargins(15, 20, 15);  // Left, Top, Right
$pdf->SetHeaderMargin(5);
$pdf->SetFooterMargin(10);
$pdf->SetAutoPageBreak(TRUE, 25);

$pdf->startPageGroup();
$pdf->AddPage('P', 'A4');

$pdf->SetFont('helvetica', '', 20);

// HTML for the front page
$html = '
<style>
    .title { text-align: center; font-size: 28pt; font-weight: bold; }
    .subtitle { text-align: center; font-size: 16pt; margin-top: 10px; }
    .details { text-align: center; font-size: 12pt; margin-top: 40px; }
    .footer { text-align: center; font-size: 10pt; position: absolute; bottom: 60px; width: 100%; }
    .credit { text-align: center; font-size: 9pt; position: absolute; bottom: 40px; width: 100%; color: #555; }
</style>

<br><br><br><br><br><br><br>
<div class="title">DFCMS</div>
<div class="subtitle">Digital Forensics Case Management System</div>

<div class="details">
    <br><br><br>
    <strong>Case Report</strong><br><br>
    <strong>Case Reference: </strong>' . $caseReference . '<br>
    <strong>Date: </strong>' . $generatedDate . '<br>
    <strong>Lead Investigator: </strong>' . $leadInvestigatorFullName . '<br>
</div>

<div class="footer">
    Report Generated By: DFCMS<br>
    Confidential Forensics Report
</div>
<div class="credit">
    Tool made by Harvey Lount (c3654483)<br>
    Dissertation Production Project @ Leeds Beckett
</div>
';

$pdf->writeHTML($html, true, false, true, false, '');



$pdf->SetFont('helvetica', '', 12);


//-------------------------------------------
//
//           Case Info
//
//-------------------------------------------

$pdf->startPageGroup();
$pdf->AddPage('P', 'A4');
$html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">'; 
$html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td> 
    <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Case Reference: ' . $caseReference . '</td></tr>'; 
$html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
$html .= '</table>';
$html .= '<br/>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->Ln(0.5);

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #5AAAFF; padding: 5px; color: white; width: 40%;">Case Reference</td><td style="border: 1px solid black; padding: 5px; width: 60%;">' . $caseReference . '</td></tr>';
$html .= '</table>';

$pdf->writeHTML($html, true, false, true, false, '');
    $pdf->Ln(0.5);

$query = "SELECT CaseReference, CaseName, LeadInvestigator, Investigator, DateCreated, DeadlineDate, Timezone, Suspect FROM cases WHERE Identifier = ?";
$stmt = $connection->prepare($query);
$stmt->bind_param("i", $identifier);  // "i" for integer type parameter
$stmt->execute();
$results = $stmt->get_result();
    
while ($row = mysqli_fetch_assoc($results)) {

    $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
    $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Case Name</td><td style="border: 1px solid black; padding: 5px; width: 60%;">' . $row['CaseName'] . '</td></tr>';
    $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Lead Investigator</td><td style="border: 1px solid black; padding: 5px; width: 60%;">' . $leadInvestigatorFullName . ' (' . $row['LeadInvestigator'] . ')</td></tr>';

    $usernames = array_map('trim', explode(',', $row['Investigator']));
    $placeholders = implode(',', array_fill(0, count($usernames), '?'));

    $sql = "SELECT Username, FullName FROM users WHERE Username IN ($placeholders)";
    $stmtUsers = $connection->prepare($sql);
    $stmtUsers->execute($usernames);

    $resultsUsers = $stmtUsers->get_result();
    $investigatorNames = [];

    while ($rowUsers = $resultsUsers->fetch_assoc()) {
        $investigatorNames[$rowUsers['Username']] = $rowUsers['FullName'];
    }

    $displayNames = [];
    foreach ($usernames as $usernameFormat) {
        $displayNames[] = $investigatorNames[$usernameFormat] . ' (' . $usernameFormat . ')<br/>';

    }
    $formattedInvestigators = implode($displayNames);
    

    $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Investigators</td><td style="border: 1px solid black; padding: 5px; width: 60%;">' . $formattedInvestigators . '</td></tr>';
    $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Timestamp Created</td><td style="border: 1px solid black; padding: 5px; width: 60%;">' . $row['DateCreated'] . '</td></tr>';
    $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Case Deadline</td><td style="border: 1px solid black; padding: 5px; width: 60%;">' . $row['DeadlineDate'] . '</td></tr>';
    $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Case Timezone</td><td style="border: 1px solid black; padding: 5px; width: 60%;">' . $row['Timezone'] . '</td></tr>';
    $html .= '</table>';

    $pdf->writeHTML($html, true, false, true, false, '');
    $pdf->Ln(0.5);
}
mysqli_stmt_close($stmt);


//-------------------------------------------
//
//           Case Notes
//
//-------------------------------------------

$pdf->startPageGroup();
$pdf->AddPage('P', 'A4'); // 'L' = Landscape, 'P' = Portrait

$sql = "SELECT Notes, NotesEditorFullName, NotesEditorUsername, NotesEditedTimestamp FROM cases WHERE Identifier = ?";
$stmt = $connection->prepare($sql);
$stmt->bind_param("s", $identifier);
$stmt->execute();
$stmt->bind_result($notes, $notesEditorFullName, $notesEditorUsername, $notesEditedTimestamp);
$stmt->fetch();
mysqli_stmt_close($stmt);

$formattedNotes = nl2br($notes);

$html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">';
$html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td>
    <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Case Notes</td></tr>';
$html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->Ln(0.5);
            
$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white; width: 40%;">Case Reference</td><td style="width: 60%;">' . ($caseReference ?? 'N/A') . '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->Ln(0.5);

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Recent Notes Editor</td><td style="width: 60%;">' . ($notesEditorFullName ?? 'N/A') . ' (' . ($notesEditorUsername ?? 'N/A') . ')</td></tr>';
$html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Noted Edited Timestamp</td><td style="width: 60%;">' . ($notesEditedTimestamp ?? 'N/A') . '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->Ln(0.5);

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white;">Notes</td></tr>';
$html .= '<tr><td>' . nl2br(($formattedNotes ?? 'N/A')) . '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');


//-------------------------------------------
//
//           Crime Scene Reports
//
//-------------------------------------------

$sqlGetScenes = "SELECT LBU06id FROM lbu06 WHERE Identifier = ?";
$stmtGetScenes = $connection->prepare($sqlGetScenes);
$stmtGetScenes->bind_param("s", $identifier);
$stmtGetScenes->execute();
$resultsGetScenes = $stmtGetScenes->get_result();

if ($resultsGetScenes->num_rows > 0) {
while ($rowScenes = mysqli_fetch_assoc($resultsGetScenes)) {

        $LBU06id = $rowScenes["LBU06id"];
        

        $pdf->startPageGroup();
        $pdf->AddPage('P', 'A4'); 

$queryLBU06 = "SELECT * FROM lbu06 WHERE Identifier = ? AND LBU06id = ?";
$stmtLBU06 = $connection->prepare($queryLBU06);
$stmtLBU06->bind_param("ss", $identifier, $LBU06id);  
$stmtLBU06->execute();
$resultsLBU06 = $stmtLBU06->get_result();

$html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">';
$html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td>';
$html .= '<td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">LBU06 - Crime Scene Report</td></tr>';
$html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->Ln(0.5);

while ($rowLBU06 = mysqli_fetch_assoc($resultsLBU06)) {

    $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">SOCO Name</td><td>' . $rowLBU06['SocoName'] . ' (' . $rowLBU06['SocoUsername'] . ')</td>';
    $html .= '<td style="font-weight: bold; background-color: #87c1ff; color: white;">Case Reference</td><td>' . $rowLBU06['CaseReference'] . '</td></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">SOCO Number</td><td>' . $rowLBU06['SocoNumber'] . '</td>';
    $html .= '<td style="font-weight: bold; background-color: #87c1ff; color: white;">Date Scene Examined</td><td>' . $rowLBU06['DateSceneExamined'] . '</td></tr>';
    $html .= '</table><br/>';
    $pdf->writeHTML($html, true, false, true, false, '');

    $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Time Arrived</td><td>' . $rowLBU06['SceneArriveTime'] . '</td></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Time Concluded</td><td>' . $rowLBU06['SceneConcluded'] . '</td></tr>';
    $html .= '</table><br/>';
    $pdf->writeHTML($html, true, false, true, false, '');

    $othersOnScene = unserialize($rowLBU06['OthersOnScene']);
    $othersTimeIn = unserialize($rowLBU06['OthersTimeIn']);
    $othersTimeOut = unserialize($rowLBU06['OthersTimeOut']);
    $rowLBU06Count = max(count($othersOnScene), count($othersTimeIn), count($othersTimeOut));

    $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
    $html .= '<tr><th colspan="3" style="background-color: #5AAAFF; color: white; font-weight: bold;">Others on the Scene</th></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Name</td><td style="font-weight: bold; background-color: #87c1ff; color: white;">Time In</td><td style="font-weight: bold; background-color: #87c1ff; color: white;">Time Out</td></tr>';

    if ($rowLBU06Count > 0) {
        for ($i = 0; $i < $rowLBU06Count; $i++) {
            $html .= '<tr><td>' . ($othersOnScene[$i] ?? 'N/A') . '</td><td>' . ($othersTimeIn[$i] ?? 'N/A') . '</td><td>' . ($othersTimeOut[$i] ?? 'N/A') . '</td></tr>';
        }
    } else {
        $html .= '<tr><td colspan="3">No data available</td></tr>';
    }

    $html .= '</table><br/>';
    $pdf->writeHTML($html, true, false, true, false, '');

    $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Type of Crime</td><td>' . $rowLBU06['TypeOfCrime'] . '</td></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Location of Crime</td><td>' . $rowLBU06['LocationOfCrime'] . '</td></tr>';
    $html .= '</table><br/>';
    $pdf->writeHTML($html, true, false, true, false, '');

    $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
    $html .= '<tr><th style="background-color: #5AAAFF; color: white; font-weight: bold;">Examination Notes</th></tr>';
    $html .= '<tr><td>' . $rowLBU06['ExaminationNotes'] . '</td></tr>';
    $html .= '</table><br/>';
    $pdf->writeHTML($html, true, false, true, false, '');

    $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
    $html .= '<tr><th style="background-color: #5AAAFF; color: white; font-weight: bold;">Evidence Collected</th>';
    $html .= '<th style="background-color: #5AAAFF; color: white; font-weight: bold;">Number of Items</th>';
    $html .= '<th style="background-color: #5AAAFF; color: white; font-weight: bold;">Location Stored</th></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Photographs of Scene</td><td>' . $rowLBU06['NumberOfPhotos'] . '</td><td>' . $rowLBU06['LocationOfPhotos'] . '</td></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Sketches of Scene</td><td>' . $rowLBU06['NumberOfSketches'] . '</td><td>' . $rowLBU06['LocationOfSketches'] . '</td></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Items for Forensic Examination</td><td colspan="2">' . $rowLBU06['NumberOfItems'] . '</td></tr>';
    $html .= '</table><br/>';
    $pdf->writeHTML($html, true, false, true, false, '');

    $disclosureExhibit = unserialize($rowLBU06['DisclosureExhibit']);
    $evidenceSeized = unserialize($rowLBU06['EvidenceSeized']);
    $handedSentBy = unserialize($rowLBU06['HandedSentBy']);
    $toPersonOrLocation = unserialize($rowLBU06['ToPersonOrLocation']);
    $disclosureTimestamp = unserialize($rowLBU06['DisclosureTimestamp']);
    $rowLBU06CountDisclosure = max(count($disclosureExhibit), count($evidenceSeized), count($handedSentBy), count($toPersonOrLocation), count($disclosureTimestamp));

    for ($i = 0; $i < $rowLBU06CountDisclosure; $i++) {
        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><th colspan="2" style="background-color: #5AAAFF; color: white; font-weight: bold;">Disclosure of Evidence</th></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Exhibit Number</td><td>' . ($disclosureExhibit[$i] ?? 'N/A') . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Evidence Seized</td><td>' . ($evidenceSeized[$i] ?? 'N/A') . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Handed/Sent By</td><td>' . ($handedSentBy[$i] ?? 'N/A') . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Handed/Sent To</td><td>' . ($toPersonOrLocation[$i] ?? 'N/A') . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Timestamp</td><td>' . ($disclosureTimestamp[$i] ?? 'N/A') . '</td></tr>';
        $html .= '</table><br/>';
        $pdf->writeHTML($html, true, false, true, false, '');
    }

    $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">SOCO Signature</td><td><img src="' . $rowLBU06['SocoSig'] . '" height="50" /></td></tr>';
    $html .= '</table><br/>';
    $pdf->writeHTML($html, true, false, true, false, '');

//-------------------------------------------
//
//           Crime Scene Files
//
//-------------------------------------------


$sql = "SELECT SceneFileID, Identifier, LBU06id, UploadType, SetName, FileName, FileType, FileSize, FileContent, UploaderFullName, 
UploaderUsername, UploadTimestamp, MD5Hash, SHA1Hash, Notes 
FROM sceneuploadedfiles 
WHERE Identifier = ? AND LBU06id = ?";
$stmt = $connection->prepare($sql);
$stmt->bind_param("ss", $identifier, $LBU06id);
$stmt->execute();
$results = $stmt->get_result();

$queryTempCaseExhibit = "SELECT CaseReference FROM evidence WHERE Identifier = ?";
$stmtTempCaseExhibit = $connection->prepare($queryTempCaseExhibit);
$stmtTempCaseExhibit->bind_param("s", $identifier);  
$stmtTempCaseExhibit->execute();
$stmtTempCaseExhibit->bind_result($tempCaseReference);
$stmtTempCaseExhibit->fetch();
mysqli_stmt_close($stmtTempCaseExhibit);

while ($row = $results->fetch_assoc()) {
if ($row['UploadType'] === "ScenePhoto") {

$pdf->startPageGroup();
$pdf->AddPage('P', 'A4');

$html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">';
$html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td>
            <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Exhibit Image File</td></tr>';
$html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->Ln(0.5);

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="background-color: #5AAAFF; color: white; font-weight: bold; width: 40%;">Case Reference</td><td style="width: 60%;">' . $tempCaseReference . '</td></tr>';
$html .= '</table><br/>';

$pdf->writeHTML($html, true, false, true, false, '');

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Memorable Name</td><td style="width: 60%;">' . $row['SetName'] . '</td></tr>';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Uploaded By</td><td style="width: 60%;">' . $row['UploaderFullName'] . ' (' . $row['UploaderUsername'] . ')</td></tr>';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Timestamp</td><td style="width: 60%;">' . $row['UploadTimestamp'] . '</td></tr>';
$html .= '</table><br/>';

$pdf->writeHTML($html, true, false, true, false, '');

$fileContentHash = $row['FileContent'];
$fileNameHash = $row['FileName'];
$fileTypeHash = $row['FileType'];

$retrievedMD5Hash = md5($fileContentHash);
$retrievedSHA1Hash = sha1($fileContentHash);
$uploadedMD5Hash = $row['MD5Hash'];
$uploadedSHA1Hash = $row['SHA1Hash'];
if ($retrievedMD5Hash === $uploadedMD5Hash && $retrievedSHA1Hash === $uploadedSHA1Hash) {
    $hashResult = "Hashes match. File integrity is verified.";
} else {
    $hashResult = "Hash mismatch. Verification failed.";
}

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Scene File ID</td><td style="width: 60%;">' . $row['SceneFileID'] . '</td></tr>';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Filename</td><td style="width: 60%;">' . $row['FileName'] . '</td></tr>';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">File Type</td><td style="width: 60%;">' . $row['FileType'] . '</td></tr>';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">File Size</td><td style="width: 60%;">' . formatBytes($row['FileSize']) . '</td></tr>';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Uploaded File MD5 Hash</td><td style="width: 60%;">' . $row['MD5Hash'] . '</td></tr>';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Uploaded File SHA1 Hash</td><td style="width: 60%;">' . $row['SHA1Hash'] . '</td></tr>'; 
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Retrieved File MD5 Hash</td><td style="width: 60%;">' . $retrievedMD5Hash . '</td></tr>';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Retrieved File SHA1 Hash</td><td style="width: 60%;">' . $retrievedSHA1Hash . '</td></tr>'; 
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">File Integrity Verification</td><td style="width: 60%;">' . $hashResult . '</td></tr>'; 
$html .= '</table><br/>';

$pdf->writeHTML($html, true, false, true, false, '');

$formattedNotes = nl2br($row['Notes']);
$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="background-color: #5AAAFF; color: white; font-weight: bold;">File Notes</td></tr>';
$html .= '<tr><td>' . $formattedNotes . '</td></tr>';
$html .= '</table><br/>';

$pdf->writeHTML($html, true, false, true, false, '');

$fileContent = $row['FileContent'];
$fileName = $row['FileName'];
$fileType = $row['FileType'];

$image_data = base64_encode($fileContent);

$image_src = 'data:' . $fileType . ';base64,' . $image_data;

$pdf->AddPage('P', 'A4');

$html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">';
$html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td>
            <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Exhibit Photo File</td></tr>';
$html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->Ln(0.5);

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="background-color: #5AAAFF; color: white; font-weight: bold;">Preview</td></tr>';
$html .= '<tr><td><img src="' . $image_src . '" alt="Preview" width=100%; height="auto" /></td></tr>'; 
$html .= '</table><br/>';

$pdf->writeHTML($html, true, false, true, false, '');
} else if ($row['UploadType'] === "SceneSketch") {

$pdf->startPageGroup();
$pdf->AddPage('P', 'A4');

$html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">';
$html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td>
            <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Exhibit Photo File</td></tr>';
$html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->Ln(0.5);

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="background-color: #5AAAFF; color: white; font-weight: bold; width: 40%;">Case Reference</td><td style="width: 60%;">' . $tempCaseReference . '</td></tr>';
$html .= '</table><br/>';

$pdf->writeHTML($html, true, false, true, false, '');

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Memorable Name</td><td style="width: 60%;">' . $row['SetName'] . '</td></tr>';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Uploaded By</td><td style="width: 60%;">' . $row['UploaderFullName'] . ' (' . $row['UploaderUsername'] . ')</td></tr>';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Timestamp</td><td style="width: 60%;">' . $row['UploadTimestamp'] . '</td></tr>';
$html .= '</table><br/>';

$pdf->writeHTML($html, true, false, true, false, '');

$retrievedMD5Hash = md5($fileContentHash);
$retrievedSHA1Hash = sha1($fileContentHash);
$uploadedMD5Hash = $row['MD5Hash'];
$uploadedSHA1Hash = $row['SHA1Hash'];
if ($retrievedMD5Hash === $uploadedMD5Hash && $retrievedSHA1Hash === $uploadedSHA1Hash) {
    $hashResult = "Hashes match. File integrity is verified.";
} else {
    $hashResult = "Hash mismatch. Verification failed.";
}

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Filename</td><td style="width: 60%;">' . $row['FileName'] . '</td></tr>';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">File Type</td><td style="width: 60%;">' . $row['FileType'] . '</td></tr>';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">File Size</td><td style="width: 60%;">' . formatBytes($row['FileSize']) . '</td></tr>';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Uploaded File MD5 Hash</td><td style="width: 60%;">' . $row['MD5Hash'] . '</td></tr>';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Uploaded File SHA1 Hash</td><td style="width: 60%;">' . $row['SHA1Hash'] . '</td></tr>'; 
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Retrieved File MD5 Hash</td><td style="width: 60%;">' . $retrievedMD5Hash . '</td></tr>';
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Retrieved File SHA1 Hash</td><td style="width: 60%;">' . $retrievedSHA1Hash . '</td></tr>'; 
$html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">File Integrity Verification</td><td style="width: 60%;">' . $hashResult . '</td></tr>'; 
$html .= '</table><br/>';

$pdf->writeHTML($html, true, false, true, false, '');

$formattedNotes = nl2br($row['Notes']);
$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="background-color: #5AAAFF; color: white; font-weight: bold;">File Notes</td></tr>';
$html .= '<tr><td>' . $formattedNotes . '</td></tr>';
$html .= '</table><br/>';

$pdf->writeHTML($html, true, false, true, false, '');

$fileContent = $row['FileContent'];
$fileName = $row['FileName'];
$fileType = $row['FileType'];

$image_data = base64_encode($fileContent);

$image_src = 'data:' . $fileType . ';base64,' . $image_data;

$pdf->AddPage('P', 'A4');

$html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">';
$html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td>
            <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Exhibit Photo File</td></tr>';
$html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->Ln(0.5);

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="background-color: #5AAAFF; color: white; font-weight: bold;">Preview</td></tr>';
$html .= '<tr><td><img src="' . $image_src . '" alt="Preview" width=100%; height="auto" /></td></tr>'; 
$html .= '</table><br/>';

$pdf->writeHTML($html, true, false, true, false, '');

}
}


mysqli_stmt_close($stmt);



}
$stmtLBU06->close();
}

$stmtGetScenes->close();
}

//-------------------------------------------
//
//           Evidence Index
//
//-------------------------------------------


$query = "SELECT * FROM evidence WHERE Identifier = $identifier";
$results = mysqli_query($connection, $query);

$numEntries = mysqli_num_rows($results);

$query2 = "SELECT CaseReference FROM cases WHERE Identifier = $identifier";
$results2 = mysqli_query($connection, $query2);

$caseReferenceRow = mysqli_fetch_assoc($results2);
$caseReference1 = $caseReferenceRow['CaseReference'] ?? 'No Case Reference';

$pdf->startPageGroup();
$pdf->AddPage('L', 'A4');

$html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">';
$html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td>';
$html .= '<td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Exhibit Index</td></tr>';
$html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white;">Case Reference</td><td>' . ($caseReference1 ?? 'N/A') . '</td></tr>';
$html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white;">Number of Exhibits</td><td>' . ($numEntries ?? 'N/A') . '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr style="background-color: #5AAAFF; color: white; font-weight: bold; text-align: center;">';
$html .= '<td style="width: 10%;">Evidence ID</td>';
$html .= '<td style="width: 10%;">Exhibit Reference</td>';
$html .= '<td style="width: 12%;">Case Reference</td>';
$html .= '<td style="width: 10%;">Seized Timestamp</td>';
$html .= '<td style="width: 10%;">Edited Timestamp</td>';
$html .= '<td style="width: 10%;">Device Type</td>';
$html .= '<td style="width: 15%;">Manufacturer</td>';
$html .= '<td style="width: 15%;">Model</td>';
$html .= '<td style="width: 8%;">Status</td>';
$html .= '</tr>';

while ($row = mysqli_fetch_assoc($results)) {
    $html .= '<tr>';
    $html .= '<td>' . htmlspecialchars($row['EvidenceID']) . '</td>';
    $html .= '<td>' . htmlspecialchars($row['ExhibitRef']) . '</td>';
    $html .= '<td>' . htmlspecialchars($caseReference) . '</td>';
    $html .= '<td>' . htmlspecialchars($row['SeizedTime']) . '</td>';
    $html .= '<td>' . htmlspecialchars($row['EditedTime']) . '</td>';
    $html .= '<td>' . htmlspecialchars($row['DeviceType']) . '</td>';
    $html .= '<td>' . htmlspecialchars($row['Manufacturer']) . '</td>';
    $html .= '<td>' . htmlspecialchars($row['Model']) . '</td>';
    $html .= '<td>' . htmlspecialchars($row['EvidenceStatus']) . '</td>';
    $html .= '</tr>';
}

$html .= '</table>';
$html .= '<br/>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->AddPage('P', 'A4');

//-------------------------------------------
//
//           Exhibit Loop
//
//-------------------------------------------

$sqlGetEvidence = "SELECT EvidenceID FROM evidence WHERE Identifier = ?";
$stmtGetEvidence = $connection->prepare($sqlGetEvidence);
$stmtGetEvidence->bind_param("s", $identifier);
$stmtGetEvidence->execute();
$resultsGetEvidence = $stmtGetEvidence->get_result();

if ($resultsGetEvidence->num_rows > 0) {
while ($rowEvidence = mysqli_fetch_assoc($resultsGetEvidence)) {
        $evidenceID = $rowEvidence["EvidenceID"];

//-------------------------------------------
//
//           Exhibit Info
//
//-------------------------------------------

$pdf->startPageGroup();
$pdf->AddPage('P', 'A4');

$sqlCaseRef = "SELECT EvidenceType FROM evidence WHERE EvidenceID = ?";
$stmt = $connection->prepare($sqlCaseRef);
$stmt->bind_param("s", $evidenceID);
$stmt->execute();
$stmt->bind_result($evidenceType);
$stmt->fetch();
mysqli_stmt_close($stmt);

if($evidenceType === 'Computer') {
    $query = "SELECT EditedTime, EditedByFullName, EditedByUsername, CaseReference, ExhibitRef, CurrentLocation, SeizedTime, EditedTime, EvidenceStatus, CurrentSeal, DeviceType, Manufacturer, 
    Model, SerialNumber, Storage, OS, CPU, RAM, MAC, IP, Firmware, Peripheral, Network FROM evidence WHERE Identifier = ? AND EvidenceID = ?";
    $stmt = $connection->prepare($query);
    $stmt->bind_param("ss", $identifier, $evidenceID);  
    $stmt->execute();
    $results = $stmt->get_result();

    while ($row = mysqli_fetch_assoc($results)) {

        $html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">'; 
        $html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td> 
            <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Exhibit Information</td></tr>'; 
        $html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
        $html .= '</table>';
        $html .= '<br/>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white; width: 40%;">Case Reference</td><td style="width: 60%;">' . $row['CaseReference'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white; width: 40%;">Exhibit Reference</td><td style="width: 60%;">' . $row['ExhibitRef'] . '</td></tr>';
        $html .= '</table><br>';

        $pdf->writeHTML($html, true, false, true, false, '');
            $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Seized Time</td><td style="width: 60%;">' . $row['SeizedTime'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Evidence Status</td><td style="width: 60%;">' . $row['EvidenceStatus'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Current Seal Number</td><td style="width: 60%;">' . $row['CurrentSeal'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Current Location</td><td style="width: 60%;">' . $row['CurrentLocation'] . '</td></tr>';
        $html .= '</table><br>';

        $pdf->writeHTML($html, true, false, true, false, '');
            $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Recent Information Editor</td><td style="width: 60%;">' . $row['EditedByFullName'] . ' (' . $row['EditedByUsername'] . ')</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Information Edited Timestamp</td><td style="width: 60%;">' . $row['EditedTime'] . '</td></tr>';
        $html .= '</table><br>';

        $pdf->writeHTML($html, true, false, true, false, '');
            $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Device Type</td><td style="width: 60%;">' . $row['DeviceType'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Manufacturer</td><td style="width: 60%;">' . $row['Manufacturer'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Device Model</td><td style="width: 60%;">' . $row['Model'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Serial Number</td><td style="width: 60%;">' . $row['SerialNumber'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Storage Capacity</td><td style="width: 60%;">' . $row['Storage'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Operating System</td><td style="width: 60%;">' . $row['OS'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">CPU</td><td style="width: 60%;">' . $row['CPU'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">RAM</td><td style="width: 60%;">' . $row['RAM'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">MAC Address</td><td style="width: 60%;">' . $row['MAC'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">IP</td><td style="width: 60%;">' . $row['IP'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Firmware</td><td style="width: 60%;">' . $row['Firmware'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Peripheral Devices</td><td style="width: 60%;">' . $row['Peripheral'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; padding: 5px; color: white; width: 40%;">Network Information</td><td style="width: 60%;">' . $row['Network'] . '</td></tr>';
        $html .= '</table><br>';

        $pdf->writeHTML($html, true, false, true, false, '');

    }
    $stmt->close();

} else if($evidenceType === 'Mobile') {
    $query = "SELECT EditedTime, EditedByFullName, EditedByUsername, CaseReference, ExhibitRef, CurrentLocation, SeizedTime, EditedTime, EvidenceStatus, CurrentSeal, DeviceType, Manufacturer, 
    Model, SerialNumber, Storage, OS, MAC, IMEI, SIM, PhoneNumber, BatteryHealth, InstalledApps, EncryptionType, AccountInfo, ScreenLock FROM evidence WHERE Identifier = ? AND EvidenceID = ?";
    $stmt = $connection->prepare($query);
    $stmt->bind_param("ss", $identifier, $evidenceID);  
    $stmt->execute();
    $results = $stmt->get_result();

    while ($row = mysqli_fetch_assoc($results)) {
        
        $html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">'; 
        $html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td> 
            <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Exhibit Information</td></tr>'; 
        $html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
        $html .= '</table>';
        $html .= '<br/>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white; width: 40%;">Case Reference</td><td style="width: 60%;">' . $row['CaseReference'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white; width: 40%;">Exhibit Reference</td><td style="width: 60%;">' . $row['ExhibitRef'] . '</td></tr>';
        $html .= '</table><br/>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Seized Time</td><td style="width: 60%;">' . $row['SeizedTime'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Evidence Status</td><td style="width: 60%;">' . $row['EvidenceStatus'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Current Seal Number</td><td style="width: 60%;">' . $row['CurrentSeal'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Current Location</td><td style="width: 60%;">' . $row['CurrentLocation'] . '</td></tr>';
        $html .= '</table><br/>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Recent Information Editor</td><td style="width: 60%;">' . $row['EditedByFullName'] . ' (' . $row['EditedByUsername'] . ')</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Information Edited Timestamp</td><td style="width: 60%;">' . $row['EditedTime'] . '</td></tr>';
        $html .= '</table><br/>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Device Type</td><td style="width: 60%;">' . $row['DeviceType'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Manufacturer</td><td style="width: 60%;">' . $row['Manufacturer'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Device Model</td><td style="width: 60%;">' . $row['Model'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Serial Number</td><td style="width: 60%;">' . $row['SerialNumber'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Storage Capacity</td><td style="width: 60%;">' . $row['Storage'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Operating System</td><td style="width: 60%;">' . $row['OS'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">MAC Address</td><td style="width: 60%;">' . $row['MAC'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">IMEI Number</td><td style="width: 60%;">' . $row['IMEI'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">SIM Information</td><td style="width: 60%;">' . $row['SIM'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Phone Number Linked to SIM</td><td style="width: 60%;">' . $row['PhoneNumber'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Battery Health</td><td style="width: 60%;">' . $row['BatteryHealth'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Installed Apps</td><td style="width: 60%;">' . $row['InstalledApps'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Encryption Type</td><td style="width: 60%;">' . $row['EncryptionType'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Account Information</td><td style="width: 60%;">' . $row['AccountInfo'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Screen Lock</td><td style="width: 60%;">' . $row['ScreenLock'] . '</td></tr>';
        $html .= '</table><br/>';
        $pdf->writeHTML($html, true, false, true, false, '');
        
    }
    $stmt->close();
} else if($evidenceType === 'ExternalStorage') {
    $query = "SELECT EditedTime, EditedByFullName, EditedByUsername, CaseReference, ExhibitRef, CurrentLocation, SeizedTime, EditedTime, EvidenceStatus, CurrentSeal, DeviceType, Manufacturer, 
    Model, SerialNumber, Storage, EncryptionType, InterfaceType, FileSystem FROM evidence WHERE Identifier = ? AND EvidenceID = ?";
    $stmt = $connection->prepare($query);
    $stmt->bind_param("ss", $identifier, $evidenceID);  
    $stmt->execute();
    $results = $stmt->get_result();

    while ($row = mysqli_fetch_assoc($results)) {
        
        $html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">'; 
        $html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">Exhibit Information</td> 
            <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;"></td></tr>'; 
        $html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
        $html .= '</table>';
        $html .= '<br/>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white; width: 40%;">Case Reference</td><td style="width: 60%;">' . $row['CaseReference'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white; width: 40%;">Exhibit Reference</td><td style="width: 60%;">' . $row['ExhibitRef'] . '</td></tr>';
        $html .= '</table><br>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Seized Time</td><td style="width: 60%;">' . $row['SeizedTime'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Evidence Status</td><td style="width: 60%;">' . $row['EvidenceStatus'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Current Seal Number</td><td style="width: 60%;">' . $row['CurrentSeal'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Current Location</td><td style="width: 60%;">' . $row['CurrentLocation'] . '</td></tr>';
        $html .= '</table><br>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Recent Information Editor</td><td style="width: 60%;">' . $row['EditedByFullName'] . ' (' . $row['EditedByUsername'] . ')</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Information Edited Timestamp</td><td style="width: 60%;">' . $row['EditedTime'] . '</td></tr>';
        $html .= '</table><br>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Device Type</td><td style="width: 60%;">' . $row['DeviceType'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Manufacturer</td><td style="width: 60%;">' . $row['Manufacturer'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Device Model</td><td style="width: 60%;">' . $row['Model'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Serial Number</td><td style="width: 60%;">' . $row['SerialNumber'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Storage Capacity</td><td style="width: 60%;">' . $row['Storage'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Encryption Type</td><td style="width: 60%;">' . $row['EncryptionType'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Interface Type</td><td style="width: 60%;">' . $row['InterfaceType'] . '</td></tr>';
        $html .= '<tr><td style="border: 1px solid black; font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">File System</td><td style="width: 60%;">' . $row['FileSystem'] . '</td></tr>';
        $html .= '</table><br>';
        $pdf->writeHTML($html, true, false, true, false, '');
        
    }
    $stmt->close();
}


//-------------------------------------------
//
//           LBU01
//
//-------------------------------------------

$query = "SELECT * FROM lbu01 WHERE Identifier = ? AND EvidenceID = ?";
$stmt = $connection->prepare($query);
$stmt->bind_param("ss", $identifier, $evidenceID);  
$stmt->execute();
$results = $stmt->get_result();

$pdf->startPageGroup();
$pdf->AddPage('P', 'A4');
        
while ($row = mysqli_fetch_assoc($results)) {

    $html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">'; 
    $html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td> 
        <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">LBU01 - Exhibit Receipt Form</td></tr>'; 
    $html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
    $html .= '</table>';
    $html .= '<br/>';
    $pdf->writeHTML($html, true, false, true, false, '');
    $pdf->Ln(0.5);

    $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Case Reference</td><td style="width: 60%;">' . $row['CaseReference'] . '</td></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Location</td><td style="width: 60%;">' . $row['Location'] . '</td></tr>';
    $html .= '</table><br>';
    $pdf->writeHTML($html, true, false, true, false, '');
    $pdf->Ln(0.5);

    $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Received From Rank</td><td style="width: 60%;">' . $row['ReceivedFromRank'] . '</td></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Received From</td><td style="width: 60%;">' . $row['ReceivedFromName'] . '</td></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Company</td><td style="width: 60%;">' . $row['ReceivedFromCompany'] . '</td></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Timestamp</td><td style="width: 60%;">' . $row['ReceivedFromTime'] . '</td></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Signature</td><td style="width: 60%;"><img src="' . $row['ReceivedFromSig'] . '" alt="Signature" height="50"></td></tr>';
    $html .= '</table><br>';
    $pdf->writeHTML($html, true, false, true, false, '');
    $pdf->Ln(0.5);

    $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Received By Rank</td><td style="width: 60%;">' . $row['ReceivedByRank'] . '</td></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Received By</td><td style="width: 60%;">' . $row['ReceivedByName'] . '</td></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Company</td><td style="width: 60%;">' . $row['ReceivedByCompany'] . '</td></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Timestamp</td><td style="width: 60%;">' . $row['ReceivedByTime'] . '</td></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Signature</td><td style="width: 60%;"><img src="' . $row['ReceivedBySig'] . '" alt="Signature" height="50"></td></tr>';
    $html .= '</table><br>';
    $pdf->writeHTML($html, true, false, true, false, '');
    $pdf->Ln(0.5);

    $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Exhibit Number</td><td style="width: 60%;">' . $row['ExhibitRef'] . '</td></tr>';
    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Seal Number</td><td style="width: 60%;">' . $row['InitialSealNumber'] . '</td></tr>';
    $html .= '<tr><th colspan="2" style="font-weight: bold; background-color: #5AAAFF; color: white;">Initial Description</th></tr>';
    $html .= '<tr><td colspan="2">' . $row['InitialDescription'] . '</td></tr>';
    $html .= '</table><br>';
    $pdf->writeHTML($html, true, false, true, false, '');

}
$stmt->close();

//-------------------------------------------
//
//           LBU02
//
//-------------------------------------------

$query = "SELECT * FROM lbu02 WHERE Identifier = ? AND EvidenceID = ?";
$stmt = $connection->prepare($query);
$stmt->bind_param("ss", $identifier, $evidenceID);  
$stmt->execute();
$results = $stmt->get_result();

$pdf->startPageGroup();
$pdf->AddPage('P', 'A4');

while ($row = mysqli_fetch_assoc($results)) {
    if ($row['ExternalBoolean'] === "true") {

    $html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">'; 
    $html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td> 
        <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">LBU02 - Exhibit Dispatch Form</td></tr>'; 
    $html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
    $html .= '</table>';
    $html .= '<br/>';
    $pdf->writeHTML($html, true, false, true, false, '');
    $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">External Email Recipient</td><td style="width: 60%;">' . $row['ExternalEmail'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Timestamp Sent</td><td style="width: 60%;">' . $row['EmailTimestamp'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">PDF MD5 Hash</td><td style="width: 60%;">' . $row['PDFMD5Hash'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">PDF SHA-1 Hash</td><td style="width: 60%;">' . $row['PDFSHA1Hash'] . '</td></tr>';
        $html .= '</table><br>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Case Reference</td><td style="width: 60%;">' . $row['CaseReference'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Location</td><td style="width: 60%;">' . $row['Location'] . '</td></tr>';
        $html .= '</table><br>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Dispatched By Rank</td><td style="width: 60%;">' . $row['DispatchedByRank'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Dispatched By Name</td><td style="width: 60%;">' . $row['DispatchedByName'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Dispatched By Company</td><td style="width: 60%;">' . $row['DispatchedByCompany'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Dispatched By Timestamp</td><td style="width: 60%;">' . $row['DispatchedByTime'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Dispatched By Signature</td><td style="width: 60%;"><img src="' . $row['DispatchedBySig'] . '" alt="Signature" height="50"></td></tr>';
        $html .= '</table><br>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Received By Rank</td><td style="width: 60%;">' . $row['ReceivedByRank'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Received By Name</td><td style="width: 60%;">' . $row['ReceivedByName'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Received By Company</td><td style="width: 60%;">' . $row['ReceivedByCompany'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Received By Timestamp</td><td style="width: 60%;">' . $row['ReceivedByTime'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Received By Signature</td><td style="width: 60%;"><img src="' . $row['ReceivedBySig'] . '" alt="Signature" height="50"></td></tr>';
        $html .= '</table><br>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Exhibit Number</td><td style="width: 60%;">' . $row['ExhibitRef'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Seal Number</td><td style="width: 60%;">' . $row['InitialSealNumber'] . '</td></tr>';
        $html .= '<tr><th colspan="2" style="font-weight: bold; background-color: #5AAAFF; color: white;">Initial Description</th></tr>';
        $html .= '<tr><td colspan="2">' . $row['InitialDescription'] . '</td></tr>';
        $html .= '</table><br>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        
    } else {
    
        $html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">'; 
        $html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td> 
            <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">LBU02 - Exhibit Dispatch Form</td></tr>'; 
        $html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
        $html .= '</table>';
        $html .= '<br/>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Case Reference</td><td style="width: 60%;">' . $row['CaseReference'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Location</td><td style="width: 60%;">' . $row['Location'] . '</td></tr>';
        $html .= '</table><br>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Dispatched By Rank</td><td style="width: 60%;">' . $row['DispatchedByRank'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Dispatched By Name</td><td style="width: 60%;">' . $row['DispatchedByName'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Dispatched By Company</td><td style="width: 60%;">' . $row['DispatchedByCompany'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Dispatched By Timestamp</td><td style="width: 60%;">' . $row['DispatchedByTime'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Dispatched By Signature</td><td style="width: 60%;"><img src="' . $row['DispatchedBySig'] . '" alt="Signature" height="50"></td></tr>';
        $html .= '</table><br>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Received By Rank</td><td style="width: 60%;">' . $row['ReceivedByRank'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Received By Name</td><td style="width: 60%;">' . $row['ReceivedByName'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Received By Company</td><td style="width: 60%;">' . $row['ReceivedByCompany'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Received By Timestamp</td><td style="width: 60%;">' . $row['ReceivedByTime'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Received By Signature</td><td style="width: 60%;"><img src="' . $row['ReceivedBySig'] . '" alt="Signature" height="50"></td></tr>';
        $html .= '</table><br>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Exhibit Number</td><td style="width: 60%;">' . $row['ExhibitRef'] . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Seal Number</td><td style="width: 60%;">' . $row['InitialSealNumber'] . '</td></tr>';
        $html .= '<tr><th colspan="2" style="font-weight: bold; background-color: #5AAAFF; color: white;">Initial Description</th></tr>';
        $html .= '<tr><td colspan="2">' . $row['InitialDescription'] . '</td></tr>';
        $html .= '</table><br>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);


    }
}
$stmt->close();


//-------------------------------------------
//
//           LBU03
//
//-------------------------------------------

$query = "SELECT CaseReference, ExhibitRef FROM evidence WHERE Identifier = ? AND EvidenceID = ?";
$stmt = $connection->prepare($query);
$stmt->bind_param("ss", $identifier, $evidenceID);  
$stmt->execute();
$stmt->bind_result($tempCaseReference, $tempExhibitReference);
$stmt->fetch();
mysqli_stmt_close($stmt);

$query = "SELECT * FROM lbu03 WHERE Identifier = ? AND EvidenceID = ?";
$stmt = $connection->prepare($query);
$stmt->bind_param("ss", $identifier, $evidenceID);  
$stmt->execute();
$results = $stmt->get_result();

$pdf->startPageGroup();
$pdf->AddPage('L', 'A4');

$html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">'; 
$html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td> 
    <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">LBU03 - Exhibit Continuity Form</td></tr>'; 
$html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
$html .= '</table>';
$html .= '<br/>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->Ln(0.5);

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Case Reference</td><td>' . $tempCaseReference . '</td></tr>';
$html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Exhibit Reference</td><td>' . $tempExhibitReference . '</td></tr>';
$html .= '</table><br>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->Ln(0.5);

mysqli_data_seek($results, 0);

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="width: 20%; font-weight: bold; background-color: #5AAAFF; color: white;">Timestamp</td><td style="width: 20%; font-weight: bold; background-color: #5AAAFF; color: white;">Action</td><td style="width: 30%; font-weight: bold; background-color: #5AAAFF; color: white;">Actioner</td><td style="width: 30%; font-weight: bold; background-color: #5AAAFF; color: white;">Removed Reason</td></tr>';

if ($row = mysqli_fetch_assoc($results)) {
    

    while ($row = mysqli_fetch_assoc($results)) {
        if (isset($row['Removed']) && $row['Removed'] === "Removed") {
            $html .= '<tr><td style="width: 20%; font-weight: bold; background-color: #ffa8a8;">' . $row['Timestamp'] . '</td><td style="width: 20%; font-weight: bold; background-color: #ffa8a8;">' . $row['Action'] . '</td><td style="width: 30%; font-weight: bold; background-color: #ffa8a8;">' . $row['FullName'] . '<br>(' . $row['Username'] . ')</td><td style="width: 30%; font-weight: bold; background-color: #ffa8a8;">' . $row['RemovedReason'] . '</td></tr>';
        } else {
            $removeLink = 'removeLBU03EntryForm.php?identifier=' . urlencode($identifier) . '&EvidenceID=' . urlencode($evidenceID) . '&LBU03id=' . urlencode($row['LBU03id']);
            $html .= '<tr><td style="width: 20%;">' . $row['Timestamp'] . '</td><td style="width: 20%;">' . $row['Action'] . '</td><td style="width: 30%;">' . $row['FullName'] . '<br>(' . $row['Username'] . ')</td><td style="width: 30%;"></td></tr>';
        }
    }
    $html .= '</table><br>';
    $pdf->writeHTML($html, true, false, true, false, '');

} else {
    $html .= '<tr><td>No Entries Found</td></tr>';
    $html .= '</table><br>';
    $pdf->writeHTML($html, true, false, true, false, '');
}
$stmt->close();

//-------------------------------------------
//
//           LBU04
//
//-------------------------------------------

$query = "SELECT CaseReference, ExhibitRef, EvidenceType FROM evidence WHERE Identifier = ? AND EvidenceID = ?";
$stmt = $connection->prepare($query);
$stmt->bind_param("ss", $identifier, $evidenceID);  
$stmt->execute();
$stmt->bind_result($tempCaseReference, $tempExhibitReference, $tempEvidenceType);
$stmt->fetch();
mysqli_stmt_close($stmt);

if ($tempEvidenceType === "Computer") {

    $query = "SELECT * FROM lbu04 WHERE Identifier = ? AND EvidenceID = ?";
    $stmt = $connection->prepare($query);
    $stmt->bind_param("ss", $identifier, $evidenceID);  
    $stmt->execute();
    $results = $stmt->get_result();

    if ($results->num_rows > 0) {
        while ($row = mysqli_fetch_assoc($results)) {

            $pdf->startPageGroup();
            $pdf->AddPage('P', 'A4');

            $html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">';
            $html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td>
            <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">LBU04 - Computer Exhibit Detail Form</td></tr>';
            $html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
            $html .= '</table><br/>';
            $pdf->writeHTML($html, true, false, true, false, '');
            $pdf->Ln(0.5);
            
            $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
            $html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white;">Case Reference</td><td>' . $row['CaseReference'] . '</td></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white;">Exhibit Reference</td><td>' . $row['ExhibitRef'] . '</td></tr>';
            $html .= '</table><br/>';
            $pdf->writeHTML($html, true, false, true, false, '');
            $pdf->Ln(0.5);
            
            $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
            $html .= '<tr><th colspan="4" style="background-color: #5AAAFF; color: white; font-weight: bold;">Details</th></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Manufacturer</td><td>' . $row['Manufacturer'] . '</td><td style="font-weight: bold; background-color: #87c1ff; color: white;">Model</td><td>' . $row['Model'] . '</td></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Serial Number</td><td>' . $row['SerialNumber'] . '</td><td style="font-weight: bold; background-color: #87c1ff; color: white;">Type</td><td>' . $row['Type'] . '</td></tr>';
            $html .= '</table><br/>';
            $pdf->writeHTML($html, true, false, true, false, '');
            $pdf->Ln(0.5);
            
            $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
            $html .= '<tr><th colspan="4" style="background-color: #5AAAFF; color: white; font-weight: bold;">Notable Damage / Marking</th></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Condition</td><td colspan="3">' . $row['ItemCondition'] . '</td></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Condition Notes</td><td colspan="3">' . $row['ConditionNotes'] . '</td></tr>';
            $html .= '</table><br/>';
            $pdf->writeHTML($html, true, false, true, false, '');
            $pdf->Ln(0.5);
            
            $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
            $html .= '<tr><th colspan="4" style="background-color: #5AAAFF; color: white; font-weight: bold;">Peripherals</th></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Optical Drive</td><td>' . $row['OpticalDrive'] . '</td><td style="font-weight: bold; background-color: #87c1ff; color: white;">Floppy Disk</td><td>' . $row['FloppyDisk'] . '</td></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Network</td><td>' . $row['Network'] . '</td><td style="font-weight: bold; background-color: #87c1ff; color: white;">Modem</td><td>' . $row['Modem'] . '</td></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Firewire</td><td>' . $row['Firewire'] . '</td><td style="font-weight: bold; background-color: #87c1ff; color: white;">Media Card Reader</td><td>' . $row['MediaCardReader'] . '</td></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">USB</td><td>' . $row['USB'] . '</td><td style="font-weight: bold; background-color: #87c1ff; color: white;">SIM Slot</td><td>' . $row['SIMSlot'] . '</td></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Battery</td><td>' . $row['Battery'] . '</td><td style="font-weight: bold; background-color: #87c1ff; color: white;">Video Card</td><td>' . $row['VideoCard'] . '</td></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Other Peripherals</td><td colspan="3">' . $row['PeripheralsOther'] . '</td></tr>';
            $html .= '</table><br/>';
            $pdf->writeHTML($html, true, false, true, false, '');
            $pdf->Ln(0.5);
            
            $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
            $html .= '<tr><th colspan="4" style="background-color: #5AAAFF; color: white; font-weight: bold;">BIOS Details</th></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">BIOS Key</td><td>' . $row['BIOSKey'] . '</td><td style="font-weight: bold; background-color: #87c1ff; color: white;">BIOS Password</td><td>' . $row['BIOSPassword'] . '</td></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">BIOS System</td><td>' . $row['BIOSSystem'] . '</td><td style="font-weight: bold; background-color: #87c1ff; color: white;">Boot Order</td><td>' . $row['BootOrder'] . '</td></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">BIOS Date</td><td>' . $row['BIOSDate'] . '</td><td style="font-weight: bold; background-color: #87c1ff; color: white;">BIOS Time</td><td>' . $row['BIOSTime'] . '</td></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Actual Date</td><td>' . $row['ActualDate'] . '</td><td style="font-weight: bold; background-color: #87c1ff; color: white;">Actual Time</td><td>' . $row['ActualTime'] . '</td></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Battery</td><td>' . $row['Battery'] . '</td><td style="font-weight: bold; background-color: #87c1ff; color: white;">Video Card</td><td>' . $row['VideoCard'] . '</td></tr>';
            $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">BIOS Notes</td><td colspan="3">' . $row['BIOSNotes'] . '</td></tr>';
            $html .= '</table><br/>';
            $pdf->writeHTML($html, true, false, true, false, '');
            $pdf->Ln(0.5);

            // Includes Modified Generative AI. Reference: R - START

            $HDDReference = unserialize($row['HDDReference']);
            $HDDManufacturer = unserialize($row['HDDManufacturer']);
            $HDDModel = unserialize($row['HDDModel']);
            $HDDSerialNumber = unserialize($row['HDDSerialNumber']);
            $HDDType = unserialize($row['HDDType']);
            $HDDSize = unserialize($row['HDDSize']);
            $ImagingMethod = unserialize($row['ImagingMethod']);
            $ImageVerified = unserialize($row['ImageVerified']);
            $HardDriveNotes = unserialize($row['HardDriveNotes']);
            
            if (!is_array($HDDReference)) $HDDReference = [];
            if (!is_array($HDDManufacturer)) $HDDManufacturer = [];
            if (!is_array($HDDModel)) $HDDModel = [];
            if (!is_array($HDDSerialNumber)) $HDDSerialNumber = [];
            if (!is_array($HDDType)) $HDDType = [];
            if (!is_array($HDDSize)) $HDDSize = [];
            if (!is_array($ImagingMethod)) $ImagingMethod = [];
            if (!is_array($ImageVerified)) $ImageVerified = [];
            if (!is_array($HardDriveNotes)) $HardDriveNotes = [];

            $rowCount = max(count($HDDReference), count($HDDManufacturer), count($HDDModel), count($HDDSerialNumber), count($HDDType), 
            count($HDDSize), count($ImagingMethod), count($ImageVerified), count($HardDriveNotes)
            );

            if ($rowCount > 0) {
                for ($i = 0; $i < $rowCount; $i++) {
                    $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
                    $html .= '<tr><th colspan="4" style="background-color: #5AAAFF; color: white; font-weight: bold;">Hard Disk</th></tr>';
                    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Reference</td><td>' . ($HDDReference[$i] ?? 'N/A') . '</td>';
                    $html .= '<td style="font-weight: bold; background-color: #87c1ff; color: white;">Manufacturer</td><td>' . ($HDDManufacturer[$i] ?? 'N/A') . '</td></tr>';
                    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Model</td><td>' . ($HDDModel[$i] ?? 'N/A') . '</td>';
                    $html .= '<td style="font-weight: bold; background-color: #87c1ff; color: white;">Serial Number</td><td>' . ($HDDSerialNumber[$i] ?? 'N/A') . '</td></tr>';
                    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Type</td><td>' . ($HDDType[$i] ?? 'N/A') . '</td>';
                    $html .= '<td style="font-weight: bold; background-color: #87c1ff; color: white;">Size</td><td>' . ($HDDSize[$i] ?? 'N/A') . '</td></tr>';
                    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Imaging Method</td><td>' . ($ImagingMethod[$i] ?? 'N/A') . '</td>';
                    $html .= '<td style="font-weight: bold; background-color: #87c1ff; color: white;">Image Verified</td><td>' . ($ImageVerified[$i] ?? 'N/A') . '</td></tr>';
                    $html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white;">Notes</td><td colspan="3">' . ($HardDriveNotes[$i] ?? 'N/A') . '</td></tr>';
                    $html .= '</table><br/>';
                    $pdf->writeHTML($html, true, false, true, false, '');
                    $pdf->Ln(0.5);
                }
            } else {
                $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
                $html .= '<tr><th colspan="4" style="background-color: #5AAAFF; color: white; font-weight: bold;">Hard Disk</th></tr>';
                $html .= '<tr><td colspan="4">No hard disk data available</td></tr>';
                $html .= '</table><br/>';
                $pdf->writeHTML($html, true, false, true, false, '');
            }
        } 
        $stmt->close();
    } else {
        $pdf->startPageGroup();
        $pdf->AddPage('P', 'A4');

        $html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">';
        $html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td>
            <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">LBU04 - Computer Exhibit Detail Form</td></tr>';
        $html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
        $html .= '</table><br/>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);
            
        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white;">Case Reference</td><td>' . $tempCaseReference . '</td></tr>';
        $html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white;">Exhibit Reference</td><td>' . $tempExhibitReference . '</td></tr>';
        $html .= '</table><br/>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td>No Computer Exhibit Detail Form Found</td></tr>';
        $html .= '</table><br/>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $stmt->close();
    }
}

//-------------------------------------------
//
//           LBU05
//
//-------------------------------------------

$pdf->startPageGroup();
$pdf->AddPage('L', 'A4');

$sqlFirstRow = 
"SELECT TimestampIn, NewLocation, SealNumberIn, ActionerIn, ActionerInUsername, ActionerOutUsername, Validate
FROM LBU05 
WHERE Identifier = ? AND EvidenceID = ? 
ORDER BY LBU05id ASC LIMIT 1";

$stmtFirstRow = $connection->prepare($sqlFirstRow);
$stmtFirstRow->bind_param("ii", $identifier, $evidenceID);
$stmtFirstRow->execute();
$resultFirstRow = $stmtFirstRow->get_result();

$query = "SELECT CaseReference, ExhibitRef FROM evidence WHERE Identifier = ? AND EvidenceID = ?";
$stmt = $connection->prepare($query);
$stmt->bind_param("ss", $identifier, $evidenceID);  
$stmt->execute();
$results = $stmt->get_result();
$rowRef = mysqli_fetch_assoc($results);
$stmt->close();

$sqlTempLocation = 
"SELECT TempLocation
FROM LBU05 
WHERE Identifier = ? AND EvidenceID = ? 
ORDER BY LBU05id DESC LIMIT 1";

$stmtTempLocation = $connection->prepare($sqlTempLocation);
$stmtTempLocation->bind_param("ii", $identifier, $evidenceID);
$stmtTempLocation->execute();
$resultTempLocation = $stmtTempLocation->get_result();

$html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">';
$html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td>
            <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">LBU05 - Exhibit Log Book</td></tr>';
$html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->Ln(0.5);
            
$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white;">Case Reference</td><td>' . $tempCaseReference . '</td></tr>';
$html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white;">Exhibit Reference</td><td>' . $tempExhibitReference . '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->Ln(0.5);

if ($resultTempLocation->num_rows > 0) {
    $rowTempLocation = $resultTempLocation->fetch_assoc();
    if (!empty($rowTempLocation['TempLocation'])) {
        $html = '<table cellpadding="5" cellspacing="0" border="1" style="width:100%; font-size:12px;">';
        $html .= '<tr><td style="font-weight:bold; background-color:#87c1ff; color:#ffffff;">Temporary Location</td><td>' . htmlspecialchars($rowTempLocation['TempLocation']) . '</td></tr>';
        $html .= '</table><br/>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);
    }
}


if ($resultFirstRow->num_rows > 0) {

    $rowFirst = $resultFirstRow->fetch_assoc();
    $html = '<table cellpadding="5" cellspacing="0" border="1" style="width:100%; font-size:12px;">';
    $html .= '<thead><tr><th style="font-weight:bold; background-color:#87c1ff; color:#ffffff;">Timestamp In</th><th style="font-weight:bold; background-color:#87c1ff; color:#ffffff;">New Location</th><th style="font-weight:bold; background-color:#87c1ff; color:#ffffff;">Seal Number</th><th style="font-weight:bold; background-color:#87c1ff; color:#ffffff;">Actioner</th></tr></thead>';
    $html .= '<tbody><tr><td>' . htmlspecialchars($rowFirst['TimestampIn'] ?? 'N/A') . '</td><td>' . htmlspecialchars($rowFirst['NewLocation'] ?? 'N/A') . '</td><td>' . htmlspecialchars($rowFirst['SealNumberIn'] ?? 'N/A') . '</td><td>' . htmlspecialchars(($rowFirst['ActionerIn'] ?? 'N/A') . ' (' . ($rowFirst['ActionerInUsername'] ?? '') . ')') . '</td></tr></tbody>';
    $html .= '</table>';

    $pdf->writeHTML($html, true, false, true, false, '');
    $pdf->Ln(0.5);
} else {
    $html = '<p>No First Entry Found</p>'; 

    $pdf->writeHTML($html, true, false, true, false, '');
    $pdf->Ln(0.5);

}


$stmtFirstRow->close();


$sqlRows = "SELECT TimestampOut, OriginalLocation, ReasonOut, SealNumberOut, ActionerOut, TimestampIn, NewLocation, SealNumberIn, ActionerIn, ActionerInUsername, ActionerOutUsername, Validate FROM LBU05 WHERE Identifier = ? AND EvidenceID = ? ORDER BY LBU05id ASC";
$stmtRows = $connection->prepare($sqlRows);
$stmtRows->bind_param("ii", $identifier, $evidenceID);
$stmtRows->execute();
$resultRows = $stmtRows->get_result();

if ($resultRows->num_rows > 0) {
    $html = '<table cellpadding="5" cellspacing="0" border="1" style="width:100%; font-size:12px;">';
    $html .= '<thead><tr><th style="font-weight:bold; background-color:#87c1ff; color:#ffffff;">Timestamp Out</th><th style="font-weight:bold; background-color:#87c1ff; color:#ffffff;">Original Location</th><th style="font-weight:bold; background-color:#87c1ff; color:#ffffff;">Reason Out</th><th style="font-weight:bold; background-color:#87c1ff; color:#ffffff;">Seal Number Out</th><th style="font-weight:bold; background-color:#87c1ff; color:#ffffff;">Actioner Out</th><th style="font-weight:bold; background-color:#87c1ff; color:#ffffff;">Timestamp In</th><th style="font-weight:bold; background-color:#87c1ff; color:#ffffff;">New Location</th><th style="font-weight:bold; background-color:#87c1ff; color:#ffffff;">Seal Number In</th><th style="font-weight:bold; background-color:#87c1ff; color:#ffffff;">Actioner In</th></tr></thead>';
    $html .= '<tbody>';

    $prevRow = null;
    while ($row = $resultRows->fetch_assoc()) {
        if ($row['Validate'] === 'Out') {
            if ($prevRow && $prevRow['Validate'] === 'Out' && $prevRow['TimestampIn'] === null) {
                $html .= '<tr><td>' . htmlspecialchars($prevRow['TimestampOut'] ?? 'N/A') . '</td><td>' . htmlspecialchars($prevRow['OriginalLocation'] ?? 'N/A') . '</td><td>' . htmlspecialchars($prevRow['ReasonOut'] ?? 'N/A') . '</td><td>' . htmlspecialchars($prevRow['SealNumberOut'] ?? 'N/A') . '</td><td>' . htmlspecialchars($prevRow['ActionerOut'] . ' (' . $prevRow['ActionerOutUsername'] . ')' ?? 'N/A') . '</td><td colspan="4">No matching "In" row</td></tr>';
                $prevRow = null;
            }
            $prevRow = $row;
        } elseif ($row['Validate'] === 'In' && $prevRow) {
            $html .= '<tr><td>' . htmlspecialchars($prevRow['TimestampOut'] ?? 'N/A') . '</td><td>' . htmlspecialchars($prevRow['OriginalLocation'] ?? 'N/A') . '</td><td>' . htmlspecialchars($prevRow['ReasonOut'] ?? 'N/A') . '</td><td>' . htmlspecialchars($prevRow['SealNumberOut'] ?? 'N/A') . '</td><td>' . htmlspecialchars($prevRow['ActionerOut'] . ' (' . $prevRow['ActionerOutUsername'] . ')' ?? 'N/A') . '</td><td>' . htmlspecialchars($row['TimestampIn'] ?? 'N/A') . '</td><td>' . htmlspecialchars($row['NewLocation'] ?? 'N/A') . '</td><td>' . htmlspecialchars($row['SealNumberIn'] ?? 'N/A') . '</td><td>' . htmlspecialchars($row['ActionerIn'] . ' (' . $row['ActionerInUsername'] . ')' ?? 'N/A') . '</td></tr>';
            $prevRow = null;
        }
    }

    if ($prevRow && $prevRow['Validate'] === 'Out') {
        $html .= '<tr><td>' . htmlspecialchars($prevRow['TimestampOut'] ?? 'N/A') . '</td><td>' . htmlspecialchars($prevRow['OriginalLocation'] ?? 'N/A') . '</td><td>' . htmlspecialchars($prevRow['ReasonOut'] ?? 'N/A') . '</td><td>' . htmlspecialchars($prevRow['SealNumberOut'] ?? 'N/A') . '</td><td>' . htmlspecialchars($prevRow['ActionerOut'] . ' (' . $prevRow['ActionerOutUsername'] . ')' ?? 'N/A') . '</td><td colspan="4"></td></tr>';
    }

    $html .= '</tbody></table><br/>';
} else {
    $html .= '<p>No Entries Found</p>';
}
$stmtRows->close();

//-------------------------------------------
//
//           Exhibit Notes
//
//-------------------------------------------

$pdf->startPageGroup();
$pdf->AddPage('P', 'A4');

$sql = "SELECT CaseReference, ExhibitRef, Notes, NotesEditorFullName, NotesEditorUsername, NotesEditedTimestamp FROM evidence WHERE Identifier = ? AND EvidenceID = ?";
$stmt = $connection->prepare($sql);
$stmt->bind_param("ss", $identifier, $evidenceID);
$stmt->execute();
$stmt->bind_result($caseReference2, $exhibitReference, $notes, $notesEditorFullName, $notesEditorUsername, $notesEditedTimestamp);
$stmt->fetch();
mysqli_stmt_close($stmt);

$formattedNotes = nl2br($notes);

$html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">';
$html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td>
    <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Exhibit Notes</td></tr>';
$html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->Ln(0.5);
            
$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white; width: 40%;">Case Reference</td><td style="width: 60%;">' . ($caseReference2 ?? 'N/A') . '</td></tr>';
$html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white; width: 40%;">Exhibit Reference</td><td style="width: 60%;">' . ($exhibitReference ?? 'N/A') . '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->Ln(0.5);

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Recent Notes Editor</td><td style="width: 60%;">' . ($notesEditorFullName ?? 'N/A') . ' (' . ($notesEditorUsername ?? 'N/A') . ')</td></tr>';
$html .= '<tr><td style="font-weight: bold; background-color: #87c1ff; color: white; width: 40%;">Noted Edited Timestamp</td><td style="width: 60%;">' . ($notesEditedTimestamp ?? 'N/A') . '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');
$pdf->Ln(0.5);

$html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
$html .= '<tr><td style="font-weight: bold; background-color: #5AAAFF; color: white;">Notes</td></tr>';
$html .= '<tr><td>' . nl2br(($formattedNotes ?? 'N/A')) . '</td></tr>';
$html .= '</table><br/>';
$pdf->writeHTML($html, true, false, true, false, '');


//-------------------------------------------
//
//           Exhibit Files
//
//-------------------------------------------

$sql = "SELECT FileID, Identifier, EvidenceID, UploadType, SetName, FileName, FileType, FileSize, FileContent, UploaderFullName, 
        UploaderUsername, UploadTimestamp, MD5Hash, SHA1Hash, Notes 
        FROM exhibituploadedfiles 
        WHERE Identifier = ? AND EvidenceID = ?";
$stmt = $connection->prepare($sql);
$stmt->bind_param("ss", $identifier, $evidenceID);
$stmt->execute();
$results = $stmt->get_result();

$queryTempCaseExhibit = "SELECT CaseReference, ExhibitRef FROM evidence WHERE Identifier = ? AND EvidenceID = ?";
$stmtTempCaseExhibit = $connection->prepare($queryTempCaseExhibit);
$stmtTempCaseExhibit->bind_param("ss", $identifier, $evidenceID);  
$stmtTempCaseExhibit->execute();
$stmtTempCaseExhibit->bind_result($tempCaseReference, $tempExhibitReference);
$stmtTempCaseExhibit->fetch();
mysqli_stmt_close($stmtTempCaseExhibit);

while ($row = $results->fetch_assoc()) {
    if ($row['UploadType'] === "Image") {

        $pdf->startPageGroup();
        $pdf->AddPage('P', 'A4');

        $html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">';
        $html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td>
                    <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Exhibit Image File</td></tr>';
        $html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
        $html .= '</table><br/>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="background-color: #5AAAFF; color: white; font-weight: bold; width: 40%;">Case Reference</td><td style="width: 60%;">' . $tempCaseReference . '</td></tr>';
        $html .= '<tr><td style="background-color: #5AAAFF; color: white; font-weight: bold; width: 40%;">Exhibit Reference</td><td style="width: 60%;">' . $tempExhibitReference . '</td></tr>';
        $html .= '</table><br/>';

        $pdf->writeHTML($html, true, false, true, false, '');

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Memorable Name</td><td style="width: 60%;">' . $row['SetName'] . '</td></tr>';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Uploaded By</td><td style="width: 60%;">' . $row['UploaderFullName'] . ' (' . $row['UploaderUsername'] . ')</td></tr>';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Timestamp</td><td style="width: 60%;">' . $row['UploadTimestamp'] . '</td></tr>';
        $html .= '</table><br/>';

        $pdf->writeHTML($html, true, false, true, false, '');

        $fileContentHash = $row['FileContent'];
        $fileNameHash = $row['FileName'];
        $fileTypeHash = $row['FileType'];

        $retrievedMD5Hash = md5($fileContentHash);
        $retrievedSHA1Hash = sha1($fileContentHash);
        $uploadedMD5Hash = $row['MD5Hash'];
        $uploadedSHA1Hash = $row['SHA1Hash'];
        if ($retrievedMD5Hash === $uploadedMD5Hash && $retrievedSHA1Hash === $uploadedSHA1Hash) {
            $hashResult = "Hashes match. File integrity is verified.";
        } else {
            $hashResult = "Hash mismatch. Verification failed.";
        }

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Exhibit File ID</td><td style="width: 60%;">' . $row['FileID'] . '</td></tr>';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Filename</td><td style="width: 60%;">' . $row['FileName'] . '</td></tr>';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">File Type</td><td style="width: 60%;">' . $row['FileType'] . '</td></tr>';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">File Size</td><td style="width: 60%;">' . formatBytes($row['FileSize']) . '</td></tr>';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Uploaded File MD5 Hash</td><td style="width: 60%;">' . $row['MD5Hash'] . '</td></tr>';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Uploaded File SHA1 Hash</td><td style="width: 60%;">' . $row['SHA1Hash'] . '</td></tr>'; 
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Retrieved File MD5 Hash</td><td style="width: 60%;">' . $retrievedMD5Hash . '</td></tr>';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Retrieved File SHA1 Hash</td><td style="width: 60%;">' . $retrievedSHA1Hash . '</td></tr>'; 
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">File Integrity Verification</td><td style="width: 60%;">' . $hashResult . '</td></tr>'; 
        $html .= '</table><br/>';

        $pdf->writeHTML($html, true, false, true, false, '');

        $formattedNotes = nl2br($row['Notes']);
        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="background-color: #5AAAFF; color: white; font-weight: bold;">File Notes</td></tr>';
        $html .= '<tr><td>' . $formattedNotes . '</td></tr>';
        $html .= '</table><br/>';

        $pdf->writeHTML($html, true, false, true, false, '');


        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="background-color: #5AAAFF; color: white; font-weight: bold;">Preview</td></tr>';
        $html .= '<tr><td>No preview available</td></tr>';
        $html .= '</table><br/>';

        $pdf->writeHTML($html, true, false, true, false, '');
    } else if ($row['UploadType'] === "ExhibitPhoto") {

        $pdf->startPageGroup();
        $pdf->AddPage('P', 'A4'); 

        $html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">';
        $html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td>
                    <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Exhibit Photo File</td></tr>';
        $html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
        $html .= '</table><br/>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="background-color: #5AAAFF; color: white; font-weight: bold; width: 40%;">Case Reference</td><td style="width: 60%;">' . $tempCaseReference . '</td></tr>';
        $html .= '<tr><td style="background-color: #5AAAFF; color: white; font-weight: bold; width: 40%;">Exhibit Reference</td><td style="width: 60%;">' . $tempExhibitReference . '</td></tr>';
        $html .= '</table><br/>';

        $pdf->writeHTML($html, true, false, true, false, '');

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Memorable Name</td><td style="width: 60%;">' . $row['SetName'] . '</td></tr>';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Uploaded By</td><td style="width: 60%;">' . $row['UploaderFullName'] . ' (' . $row['UploaderUsername'] . ')</td></tr>';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Timestamp</td><td style="width: 60%;">' . $row['UploadTimestamp'] . '</td></tr>';
        $html .= '</table><br/>';

        $pdf->writeHTML($html, true, false, true, false, '');

        $fileContentHash = $row['FileContent'];
        $fileNameHash = $row['FileName'];
        $fileTypeHash = $row['FileType'];

        $retrievedMD5Hash = md5($fileContentHash);
        $retrievedSHA1Hash = sha1($fileContentHash);
        $uploadedMD5Hash = $row['MD5Hash'];
        $uploadedSHA1Hash = $row['SHA1Hash'];
        if ($retrievedMD5Hash === $uploadedMD5Hash && $retrievedSHA1Hash === $uploadedSHA1Hash) {
            $hashResult = "Hashes match. File integrity is verified.";
        } else {
            $hashResult = "Hash mismatch. Verification failed.";
        }

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Filename</td><td style="width: 60%;">' . $row['FileName'] . '</td></tr>';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">File Type</td><td style="width: 60%;">' . $row['FileType'] . '</td></tr>';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">File Size</td><td style="width: 60%;">' . formatBytes($row['FileSize']) . '</td></tr>';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Uploaded File MD5 Hash</td><td style="width: 60%;">' . $row['MD5Hash'] . '</td></tr>';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Uploaded File SHA1 Hash</td><td style="width: 60%;">' . $row['SHA1Hash'] . '</td></tr>'; 
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Retrieved File MD5 Hash</td><td style="width: 60%;">' . $retrievedMD5Hash . '</td></tr>';
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">Retrieved File SHA1 Hash</td><td style="width: 60%;">' . $retrievedSHA1Hash . '</td></tr>'; 
        $html .= '<tr><td style="background-color: #87c1ff; color: white; font-weight: bold; width: 40%;">File Integrity Verification</td><td style="width: 60%;">' . $hashResult . '</td></tr>'; 
        $html .= '</table><br/>';

        $pdf->writeHTML($html, true, false, true, false, '');


        $formattedNotes = nl2br($row['Notes']);
        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="background-color: #5AAAFF; color: white; font-weight: bold;">File Notes</td></tr>';
        $html .= '<tr><td>' . $formattedNotes . '</td></tr>';
        $html .= '</table><br/>';

        $pdf->writeHTML($html, true, false, true, false, '');

        $fileContent = $row['FileContent'];
        $fileName = $row['FileName'];
        $fileType = $row['FileType'];

        $image_data = base64_encode($fileContent);

        $image_src = 'data:' . $fileType . ';base64,' . $image_data;

        $pdf->AddPage('P', 'A4'); 

        $html = '<table cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse; border: 2px solid #5AAAFF;">';
        $html .= '<tr><td rowspan="2" style="font-size: 26px; font-weight: bold; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white;">DFCMS</td>
                    <td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Exhibit Photo File</td></tr>';
        $html .= '<tr><td style="text-align: right; border: 2px solid #5AAAFF; background-color: #5AAAFF; color: white; font-weight: bold; font-size: 12px;">Page '.$pdf->getPageNumGroupAlias().' of '. $pdf->getPageGroupAlias(). '</td></tr>';
        $html .= '</table><br/>';
        $pdf->writeHTML($html, true, false, true, false, '');
        $pdf->Ln(0.5);

        $html = '<table border="1" cellpadding="5" cellspacing="0" style="width: 100%; border-collapse: collapse;">';
        $html .= '<tr><td style="background-color: #5AAAFF; color: white; font-weight: bold;">Preview</td></tr>';
        $html .= '<tr><td><img src="' . $image_src . '" alt="Preview" width=100%; height="auto" /></td></tr>';  // Change the width as needed
        $html .= '</table><br/>';

        $pdf->writeHTML($html, true, false, true, false, '');

        echo $evidenceID;

    }
}


mysqli_stmt_close($stmt);
}

mysqli_stmt_close($stmtGetEvidence);
}

$sanitizedCaseReference = str_replace('/', '_', $caseReference);

ob_end_clean(); // Clear buffer before output

$filename = $sanitizedCaseReference . '-Report.pdf';
$filetype = 'application/pdf';

$filecontent = $pdf->Output($filename, 'S');
$filesize = strlen($filecontent);
$fileExt = strtolower(pathinfo($filename, PATHINFO_EXTENSION));
$MD5Hash = md5($filecontent);
$SHA1Hash = sha1($filecontent);

$stmt = $connection->prepare("INSERT INTO reportfiles 
(Identifier, FileName, FileType, FileSize, FileContent, GeneratedByFullName, GeneratedByUsername, GeneratedTimestamp, MD5Hash, SHA1Hash) 
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");

$stmt->bind_param("ssssssssss", 
    $identifier, 
    $filename, 
    $filetype, 
    $filesize, 
    $filecontent, 
    $generatedByFullName, 
    $generatedByUsername, 
    $generatedTimestamp, 
    $MD5Hash, 
    $SHA1Hash
);
$stmt->execute(); 
header('location:listReports.php?identifier=' . htmlspecialchars($identifier));
exit;
?>